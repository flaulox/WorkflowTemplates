name: Build and Deploy

on:
  workflow_call:
    inputs:
      mod_version:
        description: 'Mod version (e.g., 0.0.5)'
        required: false
        type: string
      curseforge_id:
        description: 'CurseForge project ID'
        required: true
        type: string
      modrinth_id:
        description: 'Modrinth project ID'
        required: true
        type: string
    secrets:
      MODRINTH_TOKEN:
        required: true
      CURSEFORGE_TOKEN:
        required: true

env:
  JAVA_VERSION: '21'
  CURSEFORGE_ID: ${{ inputs.curseforge_id }}
  MODRINTH_ID: ${{ inputs.modrinth_id }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      # 3️⃣ Setup Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # 4️⃣ Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 5️⃣ Build the mod
      - name: Build Mod
        run: |
          MC_VERSION=$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)
          ./gradlew build -Pmod_version=$MC_VERSION-${{ inputs.mod_version }} --no-daemon

      # 6️⃣ Prepare release metadata
      - name: Prepare Release Metadata
        id: metadata
        run: |
          MOD_VERSION="${{ inputs.mod_version }}"
          MC_VERSION=$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)
          FULL_VERSION="$MC_VERSION-$MOD_VERSION"
          
          # Check if CHANGELOG.md exists
          if [ ! -f CHANGELOG.md ]; then
            echo "❌ ERROR: CHANGELOG.md not found"
            exit 1
          fi
          
          # Extract changelog from CHANGELOG.md
          CHANGELOG=$(sed -n "/## \[$FULL_VERSION\]/,/^## \[/p" CHANGELOG.md | sed '1d' | sed '/^## \[/d' | sed '/^$/d')
          
          if [ -z "$CHANGELOG" ]; then
            echo "❌ ERROR: No changelog found for version $FULL_VERSION in CHANGELOG.md"
            echo "Add a section like:"
            echo "## [$FULL_VERSION]"
            echo "- Your changes here"
            exit 1
          fi
          
          echo "✅ Changelog found in CHANGELOG.md for $FULL_VERSION"
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          
          # Extract mod name for display
          MOD_NAME=$(grep '^mod_name=' gradle.properties | cut -d'=' -f2)
          echo "display_name=$MOD_NAME $FULL_VERSION" >> $GITHUB_OUTPUT
          echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT


      # 8️⃣ Publish to CurseForge, Modrinth, and GitHub
      - name: Publish Release
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          version: ${{ steps.metadata.outputs.full_version }}
          name: ${{ steps.metadata.outputs.display_name }}
          changelog: ${{ steps.metadata.outputs.changelog }}
          game-versions: ${{ steps.metadata.outputs.mc_version }}
          files: build/libs/!(*-@(dev|sources|javadoc)).jar
          modrinth-id: ${{ env.MODRINTH_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: ${{ env.CURSEFORGE_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
